from pathlib import Path

md = """# 기능 추가 계획서 (학원 관리 프로그램)
작성일: 2025-12-16  
기술 스택: Docker · Python · Django · PostgreSQL · Bootstrap 5

---

## 1) 목표와 범위
이번 스프린트에서 아래 5개 기능을 **관리자/데스크 운영 화면 중심**으로 추가한다.

1. 📱 **QR 출석 체크**: QR 생성 + 스캔 화면(웹/모바일 브라우저)
2. 📊 **Excel 내보내기**: 학생/출결/수납 데이터 다운로드
3. 📈 **대시보드 차트**: 출석률/매출 시각화
4. 📅 **시간표/캘린더**: 수업 일정 보기
5. 💬 **알림 발송**: SMS/알림 보내기 화면(발송 로그 포함)

> 원칙: “운영자가 바로 쓰는 MVP” → 추후 자동화(Celery), 학부모 포털 등 확장 가능하도록 설계

---

## 2) 사용자 역할(권한) 정의(최소)
- **원장/관리자(Admin)**: 전체 권한
- **데스크(Staff)**: 출결, 알림 발송, 내보내기(제한), 일정 조회
- **강사(Teacher)**: 본인 반 출결/일정 조회(선택)

권장: Django `Group` + `Permission` 기반으로 화면/기능 단위 제어.

---

## 3) 화면(페이지) 설계

### A. QR 출석
- `/attendance/qr/generate/` : QR 생성(반/수업/회차 선택) → 화면에 QR 표시
- `/attendance/qr/scan/` : 스캔 화면(카메라) → 토큰 인식 후 출석 처리
- `/attendance/qr/logs/` : QR 출석 처리 로그(성공/실패 사유)

**UX 포인트**
- QR은 **짧은 만료시간**(예: 30~120초) + **회차별 토큰** 권장
- 중복 출석 처리(이미 출석 처리됨) 케이스 안내

---

### B. Excel 내보내기
- `/exports/` : 내보내기 허브(학생/출결/수납)
- `/exports/students.xlsx`
- `/exports/attendance.xlsx`
- `/exports/payments.xlsx`

**필터**
- 기간(from~to), 반, 강사, 상태(재원/퇴원), 결제 상태 등

**권한**
- 데스크는 기본 허용, 강사는 제한(본인 반) 권장

---

### C. 대시보드(차트)
- `/dashboard/` : 출석률/매출 차트 + KPI 카드(간단 요약)
  - KPI 예: 이번달 출석률, 결석률, 매출, 미수금, 신규/퇴원(선택)

**차트**
- 출석률: 월별/주별(라인)
- 매출: 월별(막대) + 결제수단(도넛, 선택)

---

### D. 시간표/캘린더
- `/timetable/` : 주간/월간 캘린더 조회(FullCalendar 적용)
  - 필터: 반/강사/강의실(선택)

**범위**
- 이번 스프린트는 “보기(View)” 중심  
- 다음 스프린트에 “등록/수정/충돌 감지” 확장 가능

---

### E. 알림 발송
- `/messages/send/` : 대상 선택 + 템플릿/내용 작성 + 발송
- `/messages/logs/` : 발송 결과/실패 사유/재시도(후속)

**대상 선택**
- 반 전체, 특정 학생, 미납자(필터), 결석자(필터)

---

## 4) 데이터 모델(ERD 수준 제안)
> 기존 프로젝트 테이블이 있다면 “추가/연동” 기준으로 조정

### 공통 기본 엔티티(가정)
- `Student`
- `Classroom`(반/강좌)
- `Enrollment`(수강 등록)
- `AttendanceRecord`
- `Payment`

### 신규/추가 모델

#### 1) QR 출석
- `QrSession`
  - `id`, `classroom(FK)`, `lesson_date`, `starts_at`, `ends_at`
  - `token`(UUID/랜덤), `expires_at`, `created_by(FK User)`
  - `status`(active/expired/closed)
- `QrScanLog`
  - `id`, `qr_session(FK)`, `student(FK, nullable)`, `scanned_at`
  - `result`(success/fail), `fail_reason`(invalid_token/expired/not_enrolled/duplicate/unknown)
  - `client_meta`(ip, user_agent 등 선택)

#### 2) 알림 발송
- `MessageTemplate`(선택)
  - `name`, `channel`(sms/kakao/email 등 확장), `content`, `is_active`
- `MessageLog`
  - `channel`, `to`, `student(FK nullable)`, `title`(선택), `content`
  - `status`(queued/sent/failed), `provider_message_id`(선택)
  - `requested_by(FK User)`, `requested_at`, `sent_at`
  - `error_code`, `error_message`

#### 3) 내보내기 기록(선택)
- `ExportLog`
  - `type`(students/attendance/payments), `filters_json`, `requested_by`, `requested_at`

---

## 5) URL/API 설계(요약)

### QR
- `POST /api/qr-sessions/` : QR 세션 생성(반/일자/만료)
- `POST /api/qr-sessions/scan/` : 토큰 + 학생(또는 식별정보) → 출석 처리
- `GET  /api/qr-sessions/{id}/` : 세션 상태/만료시간

### Dashboard
- `GET /api/dashboard/attendance-rate?from=&to=&classroom_id=`
- `GET /api/dashboard/revenue?from=&to=&classroom_id=`

### Exports
- `GET /exports/attendance.xlsx?from=&to=&classroom_id=...`

### Messages
- `POST /api/messages/send` : 대상 + 내용 + 채널 → 발송 요청(로그 남김)
- `GET  /api/messages/logs?from=&to=&status=`

---

## 6) 패키지/도구(권장)
- QR 생성: `qrcode`, `Pillow`
- Excel: `openpyxl`
- 차트: Chart.js(프론트 CDN)
- 캘린더: FullCalendar(프론트 CDN)
- 알림 발송: `requests`(또는 업체 SDK)

> 자동 발송/재시도/예약 발송까지 넣을 경우: `celery`, `redis`(+ celery beat)

---

## 7) 보안/운영 고려사항(핵심만)
- QR 토큰:
  - 짧은 만료, 재사용 제한, 세션별 토큰 로테이션
  - 스캔 API rate limit(간단히는 IP 기준 제한) 고려
- 개인정보:
  - 내보내기/알림 발송 화면은 권한 제한 + 로그 기록
- 감사 로그(선택):
  - “출석 수정”, “수납 수정”, “알림 발송”은 누가/언제 했는지 남기기 권장

---

## 8) 개발 순서(추천 스프린트)

### Sprint 1 (MVP 완성)
1. 모델/마이그레이션: `QrSession`, `QrScanLog`, `MessageLog`
2. QR 생성 화면 + 스캔 처리 API + 출석 저장 연동
3. Excel 내보내기(학생/출결/수납) + 필터
4. Dashboard API(집계) + Chart.js 화면
5. 캘린더 “보기” 화면(FullCalendar) + 일정 조회 API
6. 알림 발송 화면 + MessageLog 저장(실제 발송은 샌드박스/모의 가능)

### Sprint 2 (운영 고도화)
- Celery/Redis 도입(발송 큐, 예약 발송, 재시도)
- 템플릿/대상 필터 고도화(미납/결석 자동 추출)
- 캘린더 등록/수정 + 충돌 감지
- 내보내기 템플릿 고정 양식 + ExportLog

---

## 9) 테스트 체크리스트(최소)
- QR: 만료 토큰 거부 / 중복 출석 방지 / 미등록 학생 거부
- Export: 필터 적용 / 권한별 접근 제한
- Dashboard: 기간/반 필터 시 집계 정확성
- Calendar: 표시 범위/필터 정상
- Messages: 로그 기록(성공/실패) / 잘못된 번호 실패 처리

---

## 10) 산출물(Deliverables)
- Django 앱/모듈(권장 분리)
  - `attendance_qr`(또는 attendance 하위 모듈)
  - `exports`
  - `dashboard`
  - `timetable`
  - `messaging`
- UI
  - QR 생성/스캔
  - Export 페이지
  - Dashboard 페이지
  - Timetable 페이지
  - Message 발송/로그 페이지
- 문서
  - `.env` 예시(발송 API 키 등)
  - 운영 가이드(권한/로그/백업)

---
"""

path = Path("/mnt/data/기능추가_계획서.md")
path.write_text(md, encoding="utf-8")
str(path)

