{% extends 'base.html' %}
{% block title %}ì¼ì • ê´€ë¦¬ - Academy Manager{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet'>
<style>
    #calendar {
        max-width: 1200px;
        margin: 0 auto;
    }
    .fc-event {
        cursor: pointer;
    }
    .fc-daygrid-day.fc-day-today {
        background-color: rgba(66, 133, 244, 0.1) !important;
    }
    
    /* ì£¼ë§ ìŠ¤íƒ€ì¼ */
    .fc-day-sat {
        background-color: rgba(66, 133, 244, 0.08) !important;
    }
    .fc-day-sat .fc-daygrid-day-number {
        color: #4285f4 !important;
    }
    .fc-day-sun {
        background-color: rgba(234, 67, 53, 0.08) !important;
    }
    .fc-day-sun .fc-daygrid-day-number {
        color: #ea4335 !important;
    }
    
    /* ê³µíœ´ì¼ ìŠ¤íƒ€ì¼ */
    .fc-day-holiday {
        background-color: rgba(234, 67, 53, 0.15) !important;
    }
    .fc-day-holiday .fc-daygrid-day-number {
        color: #ea4335 !important;
        font-weight: bold;
    }
    
    .event-tooltip {
        position: absolute;
        z-index: 10001;
        background: var(--bs-dark);
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        min-width: 200px;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        font-size: 0.875rem;
    }
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        margin-right: 6px;
    }
    
    /* ê³µíœ´ì¼ ì´ë²¤íŠ¸ ë¼ë²¨ */
    .fc-holiday-event {
        background-color: transparent !important;
        border: none !important;
        color: #ea4335 !important;
        font-size: 0.7rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-calendar3 me-2"></i>ì¼ì • ê´€ë¦¬</h2>
        <div>
            <a href="{% url 'schedule:holiday_list' %}" class="btn btn-outline-danger me-2">
                <i class="bi bi-calendar-x me-1"></i>íœ´ì› ê´€ë¦¬
            </a>
            <a href="{% url 'schedule:makeup_list' %}" class="btn btn-outline-success me-2">
                <i class="bi bi-arrow-repeat me-1"></i>ë³´ê°• ê´€ë¦¬
            </a>
            <a href="{% url 'schedule:event_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>ìƒˆ ì¼ì •
            </a>
        </div>
    </div>
    
    <!-- í•„í„° -->
    <div class="card bg-dark mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">ë°˜ í•„í„°</label>
                    <select id="classFilter" class="form-select">
                        <option value="">ì „ì²´</option>
                        {% for cls in classes %}
                        <option value="{{ cls.id }}">{{ cls.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">ê°•ì‚¬ í•„í„°</label>
                    <select id="teacherFilter" class="form-select">
                        <option value="">ì „ì²´</option>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="legend-item">
                            <span class="legend-color" style="background: #4285f4;"></span> ì •ê·œ ìˆ˜ì—…
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #34a853;"></span> ë³´ê°•
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ea4335;"></span> íœ´ì›
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #fbbc04;"></span> íŠ¹ê°•
                        </div>
                        <div class="legend-item">
                            <span class="legend-color border" style="background: rgba(66, 133, 244, 0.2);"></span> í† ìš”ì¼
                        </div>
                        <div class="legend-item">
                            <span class="legend-color border" style="background: rgba(234, 67, 53, 0.2);"></span> ì¼ìš”ì¼/ê³µíœ´ì¼
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ìº˜ë¦°ë” -->
    <div class="card bg-dark">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- ì´ë²¤íŠ¸ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
            </div>
            <div class="modal-footer" id="eventModalFooter">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    // í•œêµ­ ê³µíœ´ì¼ (2024-2026)
    var koreanHolidays = {
        // 2024
        '2024-01-01': 'ì‹ ì •',
        '2024-02-09': 'ì„¤ë‚  ì—°íœ´',
        '2024-02-10': 'ì„¤ë‚ ',
        '2024-02-11': 'ì„¤ë‚  ì—°íœ´',
        '2024-02-12': 'ëŒ€ì²´ê³µíœ´ì¼',
        '2024-03-01': 'ì‚¼ì¼ì ˆ',
        '2024-04-10': 'êµ­íšŒì˜ì›ì„ ê±°ì¼',
        '2024-05-05': 'ì–´ë¦°ì´ë‚ ',
        '2024-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
        '2024-05-15': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
        '2024-06-06': 'í˜„ì¶©ì¼',
        '2024-08-15': 'ê´‘ë³µì ˆ',
        '2024-09-16': 'ì¶”ì„ ì—°íœ´',
        '2024-09-17': 'ì¶”ì„',
        '2024-09-18': 'ì¶”ì„ ì—°íœ´',
        '2024-10-03': 'ê°œì²œì ˆ',
        '2024-10-09': 'í•œê¸€ë‚ ',
        '2024-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        // 2025
        '2025-01-01': 'ì‹ ì •',
        '2025-01-28': 'ì„¤ë‚  ì—°íœ´',
        '2025-01-29': 'ì„¤ë‚ ',
        '2025-01-30': 'ì„¤ë‚  ì—°íœ´',
        '2025-03-01': 'ì‚¼ì¼ì ˆ',
        '2025-05-05': 'ì–´ë¦°ì´ë‚ ',
        '2025-05-06': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
        '2025-06-06': 'í˜„ì¶©ì¼',
        '2025-08-15': 'ê´‘ë³µì ˆ',
        '2025-10-03': 'ê°œì²œì ˆ',
        '2025-10-05': 'ì¶”ì„ ì—°íœ´',
        '2025-10-06': 'ì¶”ì„',
        '2025-10-07': 'ì¶”ì„ ì—°íœ´',
        '2025-10-09': 'í•œê¸€ë‚ ',
        '2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        // 2026
        '2026-01-01': 'ì‹ ì •',
        '2026-02-16': 'ì„¤ë‚  ì—°íœ´',
        '2026-02-17': 'ì„¤ë‚ ',
        '2026-02-18': 'ì„¤ë‚  ì—°íœ´',
        '2026-03-01': 'ì‚¼ì¼ì ˆ',
        '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
        '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
        '2026-06-06': 'í˜„ì¶©ì¼',
        '2026-08-15': 'ê´‘ë³µì ˆ',
        '2026-09-24': 'ì¶”ì„ ì—°íœ´',
        '2026-09-25': 'ì¶”ì„',
        '2026-09-26': 'ì¶”ì„ ì—°íœ´',
        '2026-10-03': 'ê°œì²œì ˆ',
        '2026-10-09': 'í•œê¸€ë‚ ',
        '2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
    };
    
    // ê³µíœ´ì¼ í™•ì¸ í•¨ìˆ˜
    function isHoliday(dateStr) {
        return koreanHolidays[dateStr] || null;
    }
    
    // ë¡œì»¬ ë‚ ì§œ ë¬¸ìì—´ ë³€í™˜ (íƒ€ì„ì¡´ ì´ìŠˆ ë°©ì§€)
    function formatLocalDate(date) {
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
    }
    
    // ê³µíœ´ì¼ ì´ë²¤íŠ¸ ìƒì„±
    function getHolidayEvents(start, end) {
        var events = [];
        var current = new Date(start);
        var endDate = new Date(end);
        
        while (current <= endDate) {
            var dateStr = formatLocalDate(current);
            var holidayName = isHoliday(dateStr);
            if (holidayName) {
                events.push({
                    id: 'holiday_' + dateStr,
                    title: 'ğŸŒ ' + holidayName,
                    start: dateStr,
                    allDay: true,
                    display: 'block',
                    backgroundColor: 'transparent',
                    borderColor: 'transparent',
                    textColor: '#ea4335',
                    classNames: ['fc-holiday-event'],
                    extendedProps: {
                        type: 'public_holiday',
                        type_display: 'ê³µíœ´ì¼'
                    }
                });
            }
            current.setDate(current.getDate() + 1);
        }
        return events;
    }
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
        },
        buttonText: {
            today: 'ì˜¤ëŠ˜',
            month: 'ì›”',
            week: 'ì£¼',
            day: 'ì¼',
            list: 'ëª©ë¡'
        },
        // ê³µíœ´ì¼ ë‚ ì§œ ì…€ ìŠ¤íƒ€ì¼ ì ìš©
        dayCellDidMount: function(info) {
            var dateStr = formatLocalDate(info.date);
            if (isHoliday(dateStr)) {
                info.el.classList.add('fc-day-holiday');
            }
        },
        events: function(info, successCallback, failureCallback) {
            var classId = document.getElementById('classFilter').value;
            var teacherId = document.getElementById('teacherFilter').value;
            
            var url = '{% url "schedule:calendar_api" %}?start=' + info.startStr + '&end=' + info.endStr;
            if (classId) url += '&class_id=' + classId;
            if (teacherId) url += '&teacher_id=' + teacherId;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // ê³µíœ´ì¼ ì´ë²¤íŠ¸ ì¶”ê°€
                    var holidayEvents = getHolidayEvents(info.start, info.end);
                    successCallback(data.concat(holidayEvents));
                })
                .catch(error => failureCallback(error));
        },
        eventClick: function(info) {
            var event = info.event;
            var props = event.extendedProps;
            
            // ê³µíœ´ì¼ í´ë¦­ì€ ëª¨ë‹¬ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (props.type === 'public_holiday') {
                return;
            }
            
            document.getElementById('eventModalTitle').textContent = event.title;
            
            var bodyHtml = '<table class="table table-dark table-sm">';
            bodyHtml += '<tr><td><strong>ìœ í˜•</strong></td><td>' + (props.type_display || '-') + '</td></tr>';
            if (props.class_name) {
                bodyHtml += '<tr><td><strong>ë°˜</strong></td><td>' + props.class_name + '</td></tr>';
            }
            if (props.teacher) {
                bodyHtml += '<tr><td><strong>ê°•ì‚¬</strong></td><td>' + props.teacher + '</td></tr>';
            }
            if (props.subject) {
                bodyHtml += '<tr><td><strong>ê³¼ëª©</strong></td><td>' + props.subject + '</td></tr>';
            }
            if (props.student_count !== undefined) {
                bodyHtml += '<tr><td><strong>ìˆ˜ê°•ìƒ</strong></td><td>' + props.student_count + '/' + props.max_students + 'ëª…</td></tr>';
            }
            if (props.location) {
                bodyHtml += '<tr><td><strong>ì¥ì†Œ</strong></td><td>' + props.location + '</td></tr>';
            }
            if (props.description) {
                bodyHtml += '<tr><td><strong>ì„¤ëª…</strong></td><td>' + props.description + '</td></tr>';
            }
            bodyHtml += '</table>';
            
            document.getElementById('eventModalBody').innerHTML = bodyHtml;
            
            // ë²„íŠ¼ (event_ë¡œ ì‹œì‘í•˜ëŠ” IDë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)
            var footerHtml = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>';
            if (event.id.startsWith('event_')) {
                var eventId = event.id.replace('event_', '');
                footerHtml = '<a href="/schedule/events/' + eventId + '/update/" class="btn btn-primary">ìˆ˜ì •</a>' +
                             '<a href="/schedule/events/' + eventId + '/delete/" class="btn btn-danger ms-2">ì‚­ì œ</a>' + footerHtml;
            }
            document.getElementById('eventModalFooter').innerHTML = footerHtml;
            
            eventModal.show();
        },
        dateClick: function(info) {
            // ë‚ ì§œ í´ë¦­ ì‹œ ìƒˆ ì´ë²¤íŠ¸ ìƒì„±
            window.location.href = '{% url "schedule:event_create" %}?date=' + info.dateStr;
        },
        eventDidMount: function(info) {
            // íœ´ì› ë°°ê²½ ì´ë²¤íŠ¸ ìŠ¤íƒ€ì¼
            if (info.event.display === 'background') {
                info.el.style.opacity = '0.3';
            }
        }
    });
    
    calendar.render();
    
    // í•„í„° ë³€ê²½ ì‹œ ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    document.getElementById('classFilter').addEventListener('change', function() {
        calendar.refetchEvents();
    });
    document.getElementById('teacherFilter').addEventListener('change', function() {
        calendar.refetchEvents();
    });
});
</script>
{% endblock %}
